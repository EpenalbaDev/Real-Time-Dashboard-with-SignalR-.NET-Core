@namespace RealTimeDashboard.Shared.Components
@using RealTimeDashboard.Models
@using RealTimeDashboard.Services
@inject ChartJsInterop ChartJs
@implements IAsyncDisposable

<div class="card">
    <h3>Transactions by Source</h3>
    <div class="chart-container-sm">
        <canvas id="@_canvasId"></canvas>
    </div>
</div>

@code {
    private const string _canvasId = "sourceChart";
    private bool _chartCreated;

    private static readonly string[] BarColors = ["#3b82f6", "#8b5cf6", "#06b6d4", "#f59e0b", "#10b981"];

    [Parameter] public IReadOnlyList<SourceBreakdown> Sources { get; set; } = [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Sources.Count > 0)
        {
            var labels = Sources.Select(s => s.Source).ToArray();
            var data = Sources.Select(s => s.Count).ToArray();
            await ChartJs.CreateBarChartAsync(_canvasId, labels, data, "Transactions", BarColors);
            _chartCreated = true;
        }
    }

    public async Task UpdateAsync(IReadOnlyList<SourceBreakdown> sources)
    {
        if (sources.Count == 0) return;

        var labels = sources.Select(s => s.Source).ToArray();
        var data = sources.Select(s => s.Count).ToArray();

        try
        {
            if (!_chartCreated)
            {
                await ChartJs.CreateBarChartAsync(_canvasId, labels, data, "Transactions", BarColors);
                _chartCreated = true;
            }
            else
            {
                await ChartJs.UpdateBarDataAsync(_canvasId, labels, data);
            }
        }
        catch (Exception) { /* JS interop may fail during reconnection */ }
    }

    public async ValueTask DisposeAsync()
    {
        if (_chartCreated)
        {
            try { await ChartJs.DestroyChartAsync(_canvasId); }
            catch (JSDisconnectedException) { }
        }
    }
}
