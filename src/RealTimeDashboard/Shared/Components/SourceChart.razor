@namespace RealTimeDashboard.Shared.Components
@using RealTimeDashboard.Models
@using RealTimeDashboard.Services
@inject ChartJsInterop ChartJs
@inject ILocalizationService Loc
@implements IAsyncDisposable

<div class="card">
    <h3>@Loc.Get("chart.sourceTitle")</h3>
    <div class="chart-container-sm">
        <canvas id="@_canvasId"></canvas>
    </div>
</div>

@code {
    private const string _canvasId = "sourceChart";
    private bool _chartCreated;

    private static readonly string[] BarColors = ["#2f81f7", "#8957e5", "#39d2c0", "#d29922", "#2ea043"];

    [Parameter] public IReadOnlyList<SourceBreakdown> Sources { get; set; } = [];
    [CascadingParameter(Name = "Lang")] public string? Lang { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Sources.Count > 0)
        {
            var labels = Sources.Select(s => s.Source).ToArray();
            var data = Sources.Select(s => s.Count).ToArray();
            await ChartJs.CreateBarChartAsync(_canvasId, labels, data, Loc.Get("chart.sourceLabel"), BarColors);
            _chartCreated = true;
        }
    }

    public async Task UpdateAsync(IReadOnlyList<SourceBreakdown> sources)
    {
        if (sources.Count == 0) return;

        var labels = sources.Select(s => s.Source).ToArray();
        var data = sources.Select(s => s.Count).ToArray();

        try
        {
            if (!_chartCreated)
            {
                await ChartJs.CreateBarChartAsync(_canvasId, labels, data, Loc.Get("chart.sourceLabel"), BarColors);
                _chartCreated = true;
            }
            else
            {
                await ChartJs.UpdateBarDataAsync(_canvasId, labels, data);
            }
        }
        catch (Exception) { /* JS interop may fail during reconnection */ }
    }

    public async ValueTask DisposeAsync()
    {
        if (_chartCreated)
        {
            try { await ChartJs.DestroyChartAsync(_canvasId); }
            catch (JSDisconnectedException) { }
        }
    }
}
